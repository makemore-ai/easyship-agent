from flask import Flask, render_template, request, jsonify
from openai import OpenAI


client = OpenAI(
    api_key="sk-3UeL3PLphF5BpAbR0HSkIplYiqYIIGo9pBl17CRwHqOClDTV", # <--åœ¨è¿™é‡Œå°† MOONSHOT_API_KEY æ›¿æ¢ä¸ºä½ ä»Ž Kimi å¼€æ”¾å¹³å°ç”³è¯·çš„ API Key
    base_url="https://api.moonshot.cn/v1", # <-- å°† base_url ä»Ž https://api.openai.com/v1 æ›¿æ¢ä¸º https://api.moonshot.cn/v1
)


app = Flask(__name__)

mbti_prompt = """ä½œä¸ºä¸€ä½èµ„æ·±çš„MBTIæ€§æ ¼ç±»åž‹æµ‹è¯•ä¸“å®¶ï¼Œä½ èƒ½å¤Ÿé€šè¿‡ä¸€ç³»åˆ—ç²¾å¿ƒè®¾è®¡çš„é—®é¢˜ï¼Œå‡†ç¡®åœ°åˆ†æžå‡ºæŸäººçš„MBTIç±»åž‹ã€‚åœ¨æµ‹è¯•ç»“æŸåŽï¼Œä½ å°†æä¾›é’ˆå¯¹æ€§çš„å»ºè®®å’Œæ·±å…¥çš„è§£é‡Šï¼Œå¸®åŠ©ä¸ªä½“æ›´å¥½åœ°ç†è§£è‡ªèº«çš„æ€§æ ¼ç‰¹è´¨ã€‚

## æµ‹è¯•é¢˜ç›®è®¾è®¡æŒ‡å—
- ä½¿ç”¨emojiæ¥å¢žæ·»è¶£å‘³æ€§å’Œç›´è§‚æ€§ï¼Œä½†è¦ç¡®ä¿å®ƒä»¬ä¸Žé—®é¢˜å†…å®¹ç´§å¯†ç›¸å…³ã€‚
- åˆ›ä½œ8-12ä¸ªæ¶‰åŠå¤šæ ·ç”Ÿæ´»èƒŒæ™¯ä¸Žå¿ƒç†åå¥½çš„MBTIæµ‹éªŒé¢˜ï¼Œæ¯ä¸ªé—®é¢˜éƒ½åº”è¯¥æ¸…æ™°åœ°åæ˜ MBTIçš„ä¸€ä¸ªæˆ–å¤šä¸ªç»´åº¦ã€‚
- åœ¨å‘ˆçŽ°é—®é¢˜æ—¶ï¼Œä¸€æ¬¡ä»…æ˜¾ç¤ºä¸€é“é¢˜ã€‚
- æ¯ä¸ªé—®é¢˜éƒ½åº”æœ‰å››ä¸ªé€‰é¡¹ï¼ˆæ ‡è®°ä¸ºA, B, C, Dï¼‰ï¼Œæ¯ä¸ªé€‰é¡¹ä»£è¡¨ä¸€ä¸ªç‰¹å®šçš„MBTIåå¥½ã€‚
- æ¯ä¸ªé—®é¢˜éƒ½åº”å…·æœ‰ç‹¬ç‰¹æ€§ï¼Œé¿å…åœ¨ä¸åŒé—®é¢˜ä¸­é‡å¤ç›¸åŒçš„ä¸»é¢˜æˆ–é€‰é¡¹ã€‚
- å‚ä¸Žè€…å›žç­”ä¸€ä¸ªé—®é¢˜åŽï¼Œç«‹å³æŒ‰ç…§ä»¥ä¸‹æ ¼å¼å±•ç¤ºä¸‹ä¸€ä¸ªé—®é¢˜ï¼š
  - å›žç­”è¿›åº¦ï¼š`[å½“å‰é¢˜ç›®åºå·/æ€»é¢˜ç›®æ•°é‡]`
  - ä¸‹ä¸€é¢˜ç›®åŠé€‰é¡¹ï¼š`[å±•ç¤ºä¸‹ä¸€é¢˜å’Œå¯¹åº”çš„é€‰é¡¹]`
- å½“æ‰€æœ‰é—®é¢˜éƒ½å›žç­”å®Œæ¯•åŽï¼Œå¯¹æ‰€æœ‰é€‰æ‹©è¿›è¡Œæ±‡æ€»åˆ†æžï¼Œå¹¶æä¾›ä¸“ä¸šçš„è¯„ä¼°å’Œå»ºè®®ã€‚

## é¢˜ç›®æ ¼å¼å¦‚ä¸‹ï¼š
å½“ä½ åœ¨ä¸€ä¸ªæ–°çš„çŽ¯å¢ƒä¸­ï¼Œä½ ä¼šï¼šðŸ¤”
A. ä¸»åŠ¨ä¸Žä»–äººäº¤æµï¼Œå¯»æ‰¾å…±åŒç‚¹ðŸ‘¥
B. è§‚å¯Ÿå‘¨å›´çš„æƒ…å†µï¼Œç­‰å¾…åˆé€‚çš„æ—¶æœºåŠ å…¥ðŸ‘€
C. ä¸“æ³¨äºŽè‡ªå·±çš„äº‹æƒ…ï¼Œä¸å¤ªåœ¨æ„ä»–äººðŸ‘¤
D. æ„Ÿåˆ°æœ‰äº›ç´§å¼ ï¼Œä¸çŸ¥é“è¯¥å¦‚ä½•èžå…¥ðŸ˜Ÿ

## æœ€ç»ˆç»“æžœå¦‚ä¸‹ï¼š
ä½ çš„MBTIæ€§æ ¼ç±»åž‹æ˜¯ï¼š"æµ‹è¯•ç»“æžœ"ðŸ“š 
ðŸ‘"æŽ¨ç†è¿‡ç¨‹"
ðŸ‘€"æµ‹è¯•ç»“æžœçš„è§£é‡Š"
ðŸ˜"æµ‹è¯•ç»“æžœçš„å»ºè®®"
ðŸ‘«ðŸ»å»ºè®®çš„ä¼´ä¾£ç±»åž‹ï¼š"å»ºè®®çš„ä¼´ä¾£ç±»åž‹"
å»ºè®®çš„èŒä¸šç±»åž‹ï¼š"å»ºè®®çš„èŒä¸šç±»åž‹'

æœ€åŽä»¥ä¸€æ®µé¼“åŠ±çš„è¯ç»“å°¾ðŸ‘ðŸ»
"""

# é…ç½®OpenAIå®¢æˆ·ç«¯

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/send_message', methods=['POST'])
def send_message():
    data = request.json
    message = data['message']
    history = data['history']
    
    try:
        # å‡†å¤‡æ¶ˆæ¯åˆ—è¡¨
        messages = [
            {"role": "system", "content": mbti_prompt}
        ]
        messages.extend(history)
        messages.append({"role": "user", "content": message})

        # è°ƒç”¨Moonshot AIçš„API
        response = client.chat.completions.create(
            model="moonshot-v1-8k",
            messages=messages,
            max_tokens=500,
            temperature=0.7
        )
        ai_response = response.choices[0].message.content.strip()
    except Exception as e:
        print(str(e))
        ai_response = f"æŠ±æ­‰,åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºçŽ°äº†é—®é¢˜"
    
    return jsonify({'response': ai_response})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8081)
