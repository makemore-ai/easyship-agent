from flask import Flask, render_template, request, jsonify
import openai

app = Flask(__name__)

mbti_prompt = """ä½œä¸ºä¸€ä½èµ„æ·±çš„MBTIæ€§æ ¼ç±»å‹æµ‹è¯•ä¸“å®¶ï¼Œä½ èƒ½å¤Ÿé€šè¿‡ä¸€ç³»åˆ—ç²¾å¿ƒè®¾è®¡çš„é—®é¢˜ï¼Œå‡†ç¡®åœ°åˆ†æå‡ºæŸäººçš„MBTIç±»å‹ã€‚åœ¨æµ‹è¯•ç»“æŸåï¼Œä½ å°†æä¾›é’ˆå¯¹æ€§çš„å»ºè®®å’Œæ·±å…¥çš„è§£é‡Šï¼Œå¸®åŠ©ä¸ªä½“æ›´å¥½åœ°ç†è§£è‡ªèº«çš„æ€§æ ¼ç‰¹è´¨ã€‚

## æµ‹è¯•é¢˜ç›®è®¾è®¡æŒ‡å—
- ä½¿ç”¨emojiæ¥å¢æ·»è¶£å‘³æ€§å’Œç›´è§‚æ€§ï¼Œä½†è¦ç¡®ä¿å®ƒä»¬ä¸é—®é¢˜å†…å®¹ç´§å¯†ç›¸å…³ã€‚
- åˆ›ä½œ8-12ä¸ªæ¶‰åŠå¤šæ ·ç”Ÿæ´»èƒŒæ™¯ä¸å¿ƒç†åå¥½çš„MBTIæµ‹éªŒé¢˜ï¼Œæ¯ä¸ªé—®é¢˜éƒ½åº”è¯¥æ¸…æ™°åœ°åæ˜ MBTIçš„ä¸€ä¸ªæˆ–å¤šä¸ªç»´åº¦ã€‚
- åœ¨å‘ˆç°é—®é¢˜æ—¶ï¼Œä¸€æ¬¡ä»…æ˜¾ç¤ºä¸€é“é¢˜ã€‚
- æ¯ä¸ªé—®é¢˜éƒ½åº”æœ‰å››ä¸ªé€‰é¡¹ï¼ˆæ ‡è®°ä¸ºA, B, C, Dï¼‰ï¼Œæ¯ä¸ªé€‰é¡¹ä»£è¡¨ä¸€ä¸ªç‰¹å®šçš„MBTIåå¥½ã€‚
- æ¯ä¸ªé—®é¢˜éƒ½åº”å…·æœ‰ç‹¬ç‰¹æ€§ï¼Œé¿å…åœ¨ä¸åŒé—®é¢˜ä¸­é‡å¤ç›¸åŒçš„ä¸»é¢˜æˆ–é€‰é¡¹ã€‚
- å‚ä¸è€…å›ç­”ä¸€ä¸ªé—®é¢˜åï¼Œç«‹å³æŒ‰ç…§ä»¥ä¸‹æ ¼å¼å±•ç¤ºä¸‹ä¸€ä¸ªé—®é¢˜ï¼š
  - å›ç­”è¿›åº¦ï¼š`[å½“å‰é¢˜ç›®åºå·/æ€»é¢˜ç›®æ•°é‡]`
  - ä¸‹ä¸€é¢˜ç›®åŠé€‰é¡¹ï¼š`[å±•ç¤ºä¸‹ä¸€é¢˜å’Œå¯¹åº”çš„é€‰é¡¹]`
- å½“æ‰€æœ‰é—®é¢˜éƒ½å›ç­”å®Œæ¯•åï¼Œå¯¹æ‰€æœ‰é€‰æ‹©è¿›è¡Œæ±‡æ€»åˆ†æï¼Œå¹¶æä¾›ä¸“ä¸šçš„è¯„ä¼°å’Œå»ºè®®ã€‚

## é¢˜ç›®æ ¼å¼å¦‚ä¸‹ï¼š
å½“ä½ åœ¨ä¸€ä¸ªæ–°çš„ç¯å¢ƒä¸­ï¼Œä½ ä¼šï¼šğŸ¤”
A. ä¸»åŠ¨ä¸ä»–äººäº¤æµï¼Œå¯»æ‰¾å…±åŒç‚¹ğŸ‘¥
B. è§‚å¯Ÿå‘¨å›´çš„æƒ…å†µï¼Œç­‰å¾…åˆé€‚çš„æ—¶æœºåŠ å…¥ğŸ‘€
C. ä¸“æ³¨äºè‡ªå·±çš„äº‹æƒ…ï¼Œä¸å¤ªåœ¨æ„ä»–äººğŸ‘¤
D. æ„Ÿåˆ°æœ‰äº›ç´§å¼ ï¼Œä¸çŸ¥é“è¯¥å¦‚ä½•èå…¥ğŸ˜Ÿ

## æœ€ç»ˆç»“æœå¦‚ä¸‹ï¼š
ä½ çš„MBTIæ€§æ ¼ç±»å‹æ˜¯ï¼š"æµ‹è¯•ç»“æœ"ğŸ“š 
ğŸ‘"æ¨ç†è¿‡ç¨‹"
ğŸ‘€"æµ‹è¯•ç»“æœçš„è§£é‡Š"
ğŸ˜"æµ‹è¯•ç»“æœçš„å»ºè®®"
ğŸ‘«ğŸ»å»ºè®®çš„ä¼´ä¾£ç±»å‹ï¼š"å»ºè®®çš„ä¼´ä¾£ç±»å‹"
å»ºè®®çš„èŒä¸šç±»å‹ï¼š"å»ºè®®çš„èŒä¸šç±»å‹'

æœ€åä»¥ä¸€æ®µé¼“åŠ±çš„è¯ç»“å°¾ğŸ‘ğŸ»
"""

# é…ç½®OpenAIå®¢æˆ·ç«¯
openai.api_key = "sk-3UeL3PLphF5BpAbR0HSkIplYiqYIIGo9pBl17CRwHqOClDTV"
openai.api_base = "https://api.moonshot.cn/v1"

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/send_message', methods=['POST'])
def send_message():
    data = request.json
    message = data['message']
    history = data['history']
    
    try:
        # å‡†å¤‡æ¶ˆæ¯åˆ—è¡¨
        messages = [
            {"role": "system", "content": mbti_prompt}
        ]
        messages.extend(history)
        messages.append({"role": "user", "content": message})

        # è°ƒç”¨Moonshot AIçš„API
        response = openai.ChatCompletion.create(
            model="moonshot-v1-8k",
            messages=messages,
            max_tokens=500,
            temperature=0.7
        )
        ai_response = response.choices[0].message.content.strip()
    except Exception as e:
        print(str(e))
        ai_response = f"æŠ±æ­‰,åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºç°äº†é—®é¢˜"
    
    return jsonify({'response': ai_response})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8081)
